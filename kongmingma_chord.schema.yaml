# Rime schema
# encoding: utf-8

### ### ### ###

反查词典: &reverse_lookup_dict flypy_light
反查词典所挂方案: &reverse_lookup_schema flypy_light

### ### ### ###


schema:
  schema_id: kongmingma_chord
  name: 空明码并击
#  icon: icons/kongmingma.ico
  version: 2024/05/12
  author:
    - 曌（空明码方案设计维护者）
    - zhanghaozhecn (Rime方案配置初始编写)
    - 叫我最右君（Rime方案改进维护）
  description: |
    空明码，是专为并击设计的编码方案，大词库(38万)，码长短(平均0.8)，8万高频词重码少(0.09%)。
  dependencies:
    - phony_kongmingma_part_user
    - phony_kongmingma_part00
    - phony_kongmingma_part01_char
    - phony_kongmingma_part01_ii
    - phony_kongmingma_part01_sym
    - phony_kongmingma_part02+03
    - phony_kongmingma_part04
    - phony_kongmingma_part05
    - phony_kongmingma_part06
    - phony_kongmingma_part99
    - *reverse_lookup_schema

switches:
  - name: ascii_mode
    reset: 0
    states: [ 中, 英 ]
  - name: force_select_mode
    reset: 1
    states: [ 默认无重上屏, 强制四码上屏 ]

engine:
  processors:
    - lua_processor@*disable_soft_cursor
    - ascii_composer
    - lua_processor@*chord_command_handler
    - recognizer
    - chord_composer
    - key_binder
    - speller
    - selector
    - express_editor
  segmentors:
    - matcher
    - abc_segmentor
    - affix_segmentor@tmp_schema_mode
    - affix_segmentor@tmp_en_mode
  translators:
    - lua_translator@*main_translator
    - table_translator@tmp_schema_mode
    - table_translator@tmp_en_mode
  filters:
    - lua_filter@*force_select
    - lua_filter@reverse_lookup_filter_when_tmp_schema_mode
    - lua_filter@char_first_cands_sort_filter
    - lua_filter@ensure_uniquifier


speller:
  auto_select: false
  alphabet: QWERTYUIOPASDFGHJKL:ZXCVBNM<>?qwertyuiopasdfghjkl;zxcvbnm,./1234567890_~!@%&*'"`


recognizer:
  patterns:
    dbl_slash_pattern: "^(//).*$"
    dbl_semicolon_pattern: "^(;;).*$"
    ii_pattern: "^(ii).*$"


tmp_en_mode:
  tag: dbl_slash_pattern
  extra_tags:
    - tmp_en_mode
  prefix: "//"
  tips: 〔 英文 〕
  ####
  dictionary: ""
  enable_user_dict: false


tmp_schema_mode:
  tag: dbl_semicolon_pattern
  extra_tags:
    - tmp_schema_mode
  prefix: ";;"
  tips: 〔 反查方案 〕
  ####
  dictionary: *reverse_lookup_dict
  enable_sentence: false
  enable_encoder: false
  enable_user_dict: false


reverse_lookup_filter_when_tmp_schema_mode:
  tags: [ tmp_schema_mode ]
  dicts_to_reverse_lookup:
    - kongmingma_part_user
    - kongmingma_part00
    - kongmingma_part01_char
    - kongmingma_part01_ii
    - kongmingma_part01_sym
    - kongmingma_part02+03
    - kongmingma_part04
    - kongmingma_part05
    - kongmingma_part06
    - kongmingma_part99





# 拆分词典和翻译器


kongmingma_part_user:
  dictionary: kongmingma_part_user
  enable_encoder: false
  enable_sentence: false
  enable_user_dict: false
  initial_quality: 99

kongmingma_part00:
  dictionary: kongmingma_part00
  enable_encoder: false
  enable_sentence: false
  enable_user_dict: false

kongmingma_part01_char:
  dictionary: kongmingma_part01_char
  enable_sentence: false
  enable_encoder: false
  enable_user_dict: false

kongmingma_part01_ii:
  dictionary: kongmingma_part01_ii
  enable_encoder: false
  enable_sentence: false
  enable_user_dict: false

kongmingma_part01_sym:
  dictionary: kongmingma_part01_sym
  enable_encoder: false
  enable_sentence: false
  enable_user_dict: false

kongmingma_part02+03:
  dictionary: kongmingma_part02+03
  enable_encoder: false
  enable_sentence: false
  enable_user_dict: false

kongmingma_part04:
  dictionary: kongmingma_part04
  enable_encoder: false
  enable_sentence: false
  enable_user_dict: false

kongmingma_part05:
  dictionary: kongmingma_part05
  enable_encoder: false
  enable_sentence: false
  enable_user_dict: false

kongmingma_part06:
  dictionary: kongmingma_part06
  enable_encoder: false
  enable_sentence: false
  enable_user_dict: false
  
kongmingma_part99:
  dictionary: kongmingma_part99
  enable_encoder: false
  enable_sentence: false
  enable_user_dict: false


















chord_composer:
  
#  finish_chord_on_first_key_release: true #有一键被释放时立刻触发合成
  
  alphabet: qazwsxedcrfvtgb12345yhnujmik,ol.p;/67890'=`[ -\]
  
  algebra:
  
    #
    ##
    # 预处理
      #
      # 声明空格所用的按键和其易于表达的变换编码
      # 增加空格还需在前面的字母表（允许接受并击的按键列表）中期添加
      
    - xform|'|一_| # 左手空格
    - xform|=|二_| # 左手次空格
#    - xform|`|三_| # 左手三空格
#    - xform|[|四_| # 左手四空格

    - xform|`|中| # 中间的空格
    - xform|\\|中| # 中间的空格

    - xform| |_一| # 右手空格
    - xform|-|_二| # 右手次空格
#    - xform|\\|_三| # 右手三空格
#    - xform|]|_四| # 右手四空格

    # 处理可能的空格区重复编码，根据需要自行开启，也可以不开启以利用某些特性
    - xform/(中)+/中/
#    - xform/((一_)|(_一))+/$1/
#    - xform/((二_)|(_二))+/$1/
#    - xform/((三_)|(_三))+/$1/
#    - xform/((四_)|(_四))+/$1/
#    - xform/((五_)|(_五))+/$1/
    
    #
    
    #上面这部分可以放在外部配置，读取了再插入chord_composer
    
    
    
    
    # 预处理区
    
    # 符号和数字映射为大写字母，分离其转义干扰
    - xlit|;,./|ACXZ|
    
    # 将编码包装（用一对尖括号包裹起来）
      # 左手编码包装
    - xform/([qwertasdfgzxcvb12345]+)/<$1>/
      # 右手编码包装
    - xform/([yuiophjklAnmCXZ67890]+)/<$1>/
    
    # 包装空格区编码
      # 包裹成： <"左左_><"_右右><"左左_右右> <"中><"左左中><"中右右><"左左中右右> 的形式，从这些形式变换来： 一_二__二_一 、 一_二_中 、 中_二_一 、 一_ 二_中_二_一 、 _二_一 、 一_二_ 、 中
    - xform/([_中一二三四五]+)/<"$1>/
      # 处理只存在左或右的情况
    - xform/<"(.*)_>/<"$1::>/
    - xform/<"_(.*)>/<"::$1>/
      # 处理左(中)右都存在的情况
    - xform/_((中)?)_/:$1:/
    - xform/_//
    - xform/::/_/
    - xform/:(.*):/$1/
    
      # 无空格的时候补一个<"无>标签
    - xform/^(.*)$/$1<"无>/
    - xform/<"(.*)><"无>/<"$1>/
    
    # 处理单手击的表示（添加下划线，表示另一手未击）  #允许存在单手配左中右空格，允许单手数字区表示
    - xform/^<([qwertasdfgzxcvb12345]+)><"(.*)>$/<$1>_<"$2>/
    - xform/^<([yuiophjklAnmCXZ67890]+)><"(.*)>$/_<$1><"$2>/
    
    
    ##########################################
    ##
    # 主处理区（顺序可以随便排）
    
      # 大写字母部分指法映射(齐列)
#    - xform=(<qv>|<mp>|<qg>|<hp>|<sef>|<jil>)=Q=  # 可以写成这样
#    - xform_<qv>|<mp>_Q_
    - xform=(<qv>|<mp>)=Q=
    - xform=(<qg>|<hp>)=Q=
#    - xform=(<sef>|<jil>)=Q=
    - xform=(<wv>|<mo>)=W=
    - xform=(<ev>|<mi>)=E=
    - xform=(<et>|<yi>)=R=
    - xform=(<qt>|<yp>)=T=
    - xform=(<wg>|<ho>)=Y=
    - xform=(<wt>|<yo>|<ser>|<uil>)=U=
    - xform=(<eg>|<hi>|<wef>|<jio>)=I=
    - xform=(<aw>|<oA>)=O=
    - xform=(<qf>|<jp>)=P=
      #
    - xform=(<av>|<mA>)=A=
    - xform=(<sv>|<ml>)=S=
    - xform=(<dv>|<mk>)=D=
    - xform=(<sg>|<hl>)=F=
    - xform=(<dg>|<hk>)=G=
    - xform=(<ar>|<uA>)=H=
#    - xform=(<xf>|<jX>)=J=
    - xform=(<db>|<nk>)=J=
    - xform=(<dr>|<uk>)=K=
    - xform=(<wf>|<jo>)=L=
    - xform=(<as>|<lA>)=:=
      #
    - xform=(<zf>|<jZ>)=Z=
    - xform=(<xd>|<kX>)=X=
#    - xform=(<xf>|<jX>)=X=
    - xform=(<cf>|<jC>)=C=
#    - xform=(<ac>|<CA>)=C=
#    - xform=(<cg>|<hC>)=C=
    - xform=(<zs>|<lZ>)=V=
#    - xform=(<db>|<nk>)=V=
    - xform=(<qw>|<op>)=B=
    - xform=(<ab>|<nA>)=B=
    - xform=(<wd>|<ko>)=N=
    - xform=(<se>|<il>)=M=
    - xform=(<at>|<yA>)=<=
    - xform=(<ag>|<hA>)=>=
    - xform=(<zx>|<XZ>)=?=
    
      # 小写字母部分指法映射(齐列)
    - xform=(<q>|<p>)=q=
    - xform=(<w>|<o>)=w=
    - xform=(<e>|<i>)=e=
    - xform=(<r>|<u>)=r=
    - xform=(<t>|<y>)=t=
    - xform=(<ef>|<ji>)=y=
    - xform=(<er>|<ui>)=u=
    - xform=(<we>|<io>)=i=
    - xform=(<wr>|<uo>)=o=
    - xform=(<qr>|<up>)=p=
      #
    - xform=(<a>|<A>)=a=
    - xform=(<s>|<l>)=s=
    - xform=(<d>|<k>)=d=
    - xform=(<f>|<j>)=f=
    - xform=(<g>|<h>)=g=
    - xform=(<sr>|<ul>)=h=
    - xform=(<df>|<jk>)=j=
    - xform=(<sd>|<kl>)=k=
    - xform=(<sf>|<jl>)=l=
    - xform=(<af>|<jA>)=;=
      #
    - xform=(<z>|<Z>)=z=
    - xform=(<x>|<X>)=x=
    - xform=(<c>|<C>)=c=
    - xform=(<v>|<m>)=v=
    - xform=(<b>|<n>)=b=
    - xform=(<sc>|<Cl>)=n=
    - xform=(<cv>|<mC>)=m=
    - xform=(<xc>|<CX>)=,=
    - xform=(<xv>|<mX>)=.=
    - xform=(<zv>|<mZ>)=/=
    
      # 数字部分指法映射
    - xform=(<1>)=1=
    - xform=(<2>)=2=
    - xform=(<3>)=3=
    - xform=(<4>)=4=
    - xform=(<5>)=5=
    - xform=(<35>)=6=
    - xform=(<34>)=7=
    - xform=(<23>)=8=
    - xform=(<24>)=9=
    - xform=(<14>)=0=
    - xform=(<12>)=!=
      #
    - xform=(<6>)=6=
    - xform=(<7>)=7=
    - xform=(<8>)=8=
    - xform=(<9>)=9=
    - xform=(<0>)=0=
    - xform=(<68>)="=
    - xform=(<78>)=%=
    - xform=(<89>)=~=
    - xform=(<79>)=@=
    - xform=(<70>)=*=
    - xform=(<90>)=&=
    
    
    - xform=(<wer>)=8=
    - xform=(<sdf>)=7=
    - xform=(<xcv>)=9=
    - xform=(<asdf>)=0=
    
    - xform=(<uio>)=~=
    - xform=(<jkl>)=`=
    - xform=(<mCX>)=!=
    - xform=(<jkl;>)=@=


    # 主映射区结束
    
    ####
    ##
    
    
    ########################################

    
    - xform/^UU<"无>$/ /
    - xform/^1i$/<"1>/
    - xform/^2i$/<"2>/
    - xform/^3i$/<"3>/
    - xform/^4i$/<"4>/

    
    #
    
      # 空格组合区
    - xform=(.+)_<"无>=$1_<"0>=
    - xform=_(.+)<"无>=_$1<"0>=
    - xform=(.+)<"无>=$1<"0>=
    - xform=^<"无>==
    
    - xform|(.+)_<"一_>|$1_<"1>|
    - xform|_(.+)<"一_>|_$1<"1>|
    - xform|(.+)<"一_>|$1<"1>|
    - xform|^<"一_>|<"2>|
    
    - xform|(.+)_<"_一>|$1_<"1>|
    - xform|_(.+)<"_一>|_$1<"1>|
    - xform|(.+)<"_一>|$1<"1>|
    - xform|^<"_一>|<"1>|
    
    - xform|(.+)_<"二_>|$1_<"0>。|
    - xform|_(.+)<"二_>|_$1<"0>。|
    - xform|(.+)<"二_>|$1<"0>。|
    - xform|^<"二_>|<"4>|
    
    - xform|(.+)_<"_二>|$1_<"0>，|
    - xform|_(.+)<"_二>|_$1<"0>，|
    - xform|(.+)<"_二>|$1<"0>，|
    - xform|^<"_二>|<"3>|
    
    - xform|(.+)_<"一_一>|$1_<"0>；|
    - xform|_(.+)<"一_一>|_$1<"0>；|
    - xform|(.+)<"一_一>|$1<"0>；|
    - xform|^<"一_一>|<"2>|
    
    - xform|(.+)<"二_二>|$1<"0>、|
    - xform|^<"二_二>|<"5>|
    
    - xform|(.+)_<"一二_>|$1_<"1>。|
    - xform|(.+)_<"一_二>|$1_<"1>，|
    - xform|_(.+)<"_二一>|_$1<"1>，|
    - xform|_(.+)<"二_一>|_$1<"1>。|
    - xform|(.+)<"一二_>|$1<"2>。|
    - xform|(.+)<"_二一>|$1<"2>，|
    
    ##########
    #主处理区可以写在chord_composer里让用户自行处理
    
    
    #
#    - xform=^.*(<"?[0-9]>)$=$1|$2|=
    
    
      # 屏蔽未定义的指法
    - xform/<无>//
    - xform=(__)<".+>==
    - xform/.*<.+>.*(<".+>)/$1/ #不要用erase，太奇怪了……
    
    
    # 处理双边数字上屏
    - xform/^([0-9])([0-9])$/$1__$2/
    


#  output_format:
    #输出后处理
    
    
    # 使用竖线作为分界符
    - xform=<"(.+)>(.*)$=|$1$2|=
    - xlit/无一二三四五中/012345C/
    - xlit|；，。、|;,./|
    
  comment:
#  prompt_format:
    # 并击合成过程中指法提示
    
    - xform=<"(.*)>=:$1=
    - xform=^ $=_=
    - xlit|一二|壹贰|
#    - xlit/无壹贰三四五中/⓪①②③④⑤©/
    








key_binder:
  bindings:
#    - { accept: bracketleft, send: Page_Up, when: paging } # [上翻页
#    - { accept: bracketleft, send: Page_Up, when: has_menu }
#    - { accept: bracketright, send: Page_Down, when: has_menu } # ]下翻页
    - { when: composing, accept: BackSpace, send: Escape }
    - { when: composing, accept: Delete, send: BackSpace }


# 用Shift切换中英文
ascii_composer:
  good_old_caps_lock: false
  switch_key:
    Shift_L: commit_code
    Shift_R: commit_code
#    Caps_Lock: clear


#为了不要天天在日志里警告缺失标点处理器勉为其难补一个
punctuator:
  full_shape:
    "" : { commit: "" }
  half_shape:
    "" : { commit: "" }



#要写在.custom.yaml文件里
#__patch:
#  - patch/+:
#      __include: grammar:/huayu #语言模型



# 不要使用这个pack的功能，这个pack模式可以(将会)对packs的部分不编译出棱镜文件.prism和反查词典.reverse.bin文件
#translator:
#  dictionary: kongmingma_user
#  packs:
#    - kongmingma_user
#    - kongmingma_part00
#    - kongmingma_part01_char
#    - kongmingma_part01_ii
#    - kongmingma_part01_symbols
#    - kongmingma_part02
#    - kongmingma_part03
#    - kongmingma_part04
#    - kongmingma_part06
#    - kongmingma_part99